<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Book Library - Read Online</title>
    <!-- EPUB.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.88/epub.min.css">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333; 
            line-height: 1.6; 
            min-height: 100vh;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        header { 
            text-align: center; 
            color: white; 
            margin-bottom: 40px; 
            padding: 40px 0; 
        }
        
        header h1 { 
            font-size: 3rem; 
            margin-bottom: 10px; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
        }
        
        header p { 
            font-size: 1.2rem; 
            opacity: 0.9; 
        }
        
        .stats { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            display: flex; 
            justify-content: space-around; 
            flex-wrap: wrap;
        }
        
        .stat-item { 
            text-align: center; 
            padding: 10px; 
        }
        
        .stat-number { 
            font-size: 2rem; 
            font-weight: bold; 
            color: #667eea; 
        }
        
        .stat-label { 
            color: #666; 
            font-size: 0.9rem; 
        }
        
        .genres-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 40px;
        }
        
        .genre-card { 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        .genre-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 30px rgba(0,0,0,0.2); 
        }
        
        .genre-name { 
            font-size: 1.3rem; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 10px; 
        }
        
        .genre-count { 
            color: #667eea; 
            font-weight: bold; 
        }
        
        .books-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
            gap: 25px; 
        }
        
        .book-card { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
            transition: all 0.3s ease;
        }
        
        .book-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 12px 35px rgba(0,0,0,0.15); 
        }
        
        .book-title { 
            font-size: 1.4rem; 
            font-weight: bold; 
            color: #2c3e50; 
            margin-bottom: 10px; 
            line-height: 1.3; 
        }
        
        .book-author { 
            color: #667eea; 
            font-weight: 600; 
            margin-bottom: 8px; 
        }
        
        .book-meta { 
            color: #666; 
            font-size: 0.9rem; 
            margin-bottom: 8px; 
        }
        
        .book-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .book-download, .book-read { 
            display: inline-block; 
            color: white; 
            padding: 8px 16px; 
            border-radius: 20px; 
            text-decoration: none; 
            font-weight: bold; 
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .book-download { 
            background: #667eea; 
        }
        
        .book-download:hover { 
            background: #5a6fd8; 
        }
        
        .book-read { 
            background: #28a745; 
        }
        
        .book-read:hover { 
            background: #218838; 
        }
        
        .book-read.disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .filters { 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            margin-bottom: 30px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .search-box { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e1e5e9; 
            border-radius: 8px; 
            font-size: 1rem; 
            margin-bottom: 15px;
        }
        
        .genre-filters { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        
        .genre-filter { 
            background: #f8f9fa; 
            border: 2px solid #e9ecef; 
            padding: 8px 16px; 
            border-radius: 20px; 
            cursor: pointer; 
            transition: all 0.3s ease;
        }
        
        .genre-filter.active { 
            background: #667eea; 
            color: white; 
            border-color: #667eea; 
        }

        /* EPUB Reader Modal Styles */
        .reader-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .reader-container {
            position: relative;
            width: 95%;
            height: 95%;
            margin: 2.5% auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .reader-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reader-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .reader-controls {
            display: flex;
            gap: 10px;
        }

        .reader-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .reader-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .reader-close {
            background: #e74c3c;
        }

        .reader-close:hover {
            background: #c0392b;
        }

        #viewer {
            width: 100%;
            height: calc(100% - 60px);
            background: #f8f9fa;
        }

        /* Loading spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #667eea;
            font-size: 1.2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .genres-grid, .books-grid { 
                grid-template-columns: 1fr; 
            }
            
            header h1 { 
                font-size: 2rem; 
            }
            
            .reader-container {
                width: 100%;
                height: 100%;
                margin: 0;
                border-radius: 0;
            }
            
            .book-actions {
                flex-direction: column;
            }
            
            .book-download, .book-read {
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 20px 0;
            }
            
            .stats {
                padding: 15px;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>📚 Modern Book Library</h1>
            <p>Read contemporary books directly in your browser</p>
        </div>
    </header>

    <div class="container">
        <div class="stats" id="stats">
            <!-- Stats will be loaded by JavaScript -->
        </div>

        <div class="filters">
            <input type="text" class="search-box" id="searchBox" placeholder="Search books by title, author, or genre...">
            <div class="genre-filters" id="genreFilters">
                <!-- Genre filters will be loaded by JavaScript -->
            </div>
        </div>

        <div class="genres-grid" id="genresGrid">
            <!-- Genre cards will be loaded by JavaScript -->
        </div>

        <div class="books-grid" id="booksGrid">
            <!-- Book cards will be loaded by JavaScript -->
        </div>
    </div>

    <!-- EPUB Reader Modal -->
    <div class="reader-modal" id="readerModal">
        <div class="reader-container">
            <div class="reader-header">
                <div class="reader-title" id="readerBookTitle">Reading: <span id="currentBookTitle"></span></div>
                <div class="reader-controls">
                    <button class="reader-btn" id="prevPage">Previous</button>
                    <button class="reader-btn" id="nextPage">Next</button>
                    <button class="reader-btn" id="readerClose" class="reader-close">Close</button>
                </div>
            </div>
            <div id="viewer"></div>
        </div>
    </div>

    <!-- EPUB.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.88/epub.min.js"></script>
    
    <script>
        // Global variables
        let allBooks = [];
        let allGenres = [];
        let currentBook = null;
        let rendition = null;

        // Load your book data
        fetch('archive_library.json')
            .then(response => response.json())
            .then(data => {
                allBooks = data.books;
                allGenres = data.genres;
                displayStats(data);
                displayGenres(data);
                displayBooks(allBooks);
                setupFilters(data);
            })
            .catch(error => {
                console.error('Error loading book data:', error);
                document.getElementById('booksGrid').innerHTML = 
                    '<div class="loading"><div class="spinner"></div>Error loading books. Make sure archive_library.json is in the same directory.</div>';
            });

        function displayStats(data) {
            const stats = data.metadata;
            document.getElementById('stats').innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${stats.total_books}</div>
                    <div class="stat-label">Total Books</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${stats.total_genres}</div>
                    <div class="stat-label">Genres</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${new Date(stats.generated).getFullYear()}</div>
                    <div class="stat-label">Last Updated</div>
                </div>
            `;
        }

        function displayGenres(data) {
            const genresGrid = document.getElementById('genresGrid');
            const genreFilters = document.getElementById('genreFilters');
            
            let genresHTML = '';
            let filtersHTML = '<div class="genre-filter active" data-genre="all">All Genres</div>';
            
            data.genres.slice(0, 12).forEach(genre => {
                genresHTML += `
                    <div class="genre-card" onclick="filterByGenre('${genre.name}')">
                        <div class="genre-name">${genre.name}</div>
                        <div class="genre-count">${genre.book_count} books</div>
                    </div>
                `;
                
                filtersHTML += `
                    <div class="genre-filter" data-genre="${genre.name}">${genre.name}</div>
                `;
            });
            
            genresGrid.innerHTML = genresHTML;
            genreFilters.innerHTML = filtersHTML;
        }

        function displayBooks(books, filterGenre = 'all') {
            const booksGrid = document.getElementById('booksGrid');
            
            if (books.length === 0) {
                booksGrid.innerHTML = '<div class="loading" style="grid-column: 1/-1;">No books found matching your criteria.</div>';
                return;
            }
            
            let booksHTML = '';
            
            const filteredBooks = filterGenre === 'all' 
                ? books 
                : books.filter(book => 
                    book.meaningful_genres?.some(genre => 
                        genre.toLowerCase().includes(filterGenre.toLowerCase())
                    ) ||
                    book.subjects?.some(subject => 
                        subject.toLowerCase().includes(filterGenre.toLowerCase())
                    )
                );
            
            filteredBooks.slice(0, 100).forEach(book => {
                // Extract year from publication date
                let year = 'Unknown';
                if (book.publication_date) {
                    const yearMatch = book.publication_date.match(/\d{4}/);
                    if (yearMatch) year = yearMatch[0];
                }
                
                // Check if EPUB is available for reading
                const hasEpub = book.file_format === 'EPUB' || 
                               (book.download_url && book.download_url.toLowerCase().includes('.epub'));
                
                booksHTML += `
                    <div class="book-card">
                        <div class="book-title">${book.title}</div>
                        <div class="book-author">👤 ${book.author}</div>
                        <div class="book-meta">📅 ${year}</div>
                        <div class="book-meta">📊 ${book.downloads?.toLocaleString() || 0} downloads</div>
                        <div class="book-meta">📁 ${book.file_format}</div>
                        ${book.meaningful_genres ? `<div class="book-meta">🎯 ${book.meaningful_genres.slice(0,2).join(', ')}</div>` : ''}
                        
                        <div class="book-actions">
                            ${hasEpub ? 
                                `<button class="book-read" onclick="openEpubReader('${book.download_url}', '${book.title.replace(/'/g, "\\'")}')">
                                    📖 Read Online
                                </button>` :
                                `<button class="book-read disabled" title="EPUB format not available for online reading">
                                    📖 Read Online
                                </button>`
                            }
                            <a href="${book.download_url}" class="book-download" target="_blank" download>
                                ⬇️ Download ${book.file_format}
                            </a>
                            <a href="${book.archive_url}" class="book-download" target="_blank" style="background: #6f42c1;">
                                🌐 View on Archive
                            </a>
                        </div>
                    </div>
                `;
            });
            
            booksGrid.innerHTML = booksHTML;
        }

        function setupFilters(data) {
            const searchBox = document.getElementById('searchBox');
            const genreFilters = document.querySelectorAll('.genre-filter');
            
            searchBox.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredBooks = allBooks.filter(book => 
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    book.meaningful_genres?.some(genre => 
                        genre.toLowerCase().includes(searchTerm)
                    ) ||
                    book.subjects?.some(subject => 
                        subject.toLowerCase().includes(searchTerm)
                    )
                );
                displayBooks(filteredBooks);
            });
            
            genreFilters.forEach(filter => {
                filter.addEventListener('click', () => {
                    genreFilters.forEach(f => f.classList.remove('active'));
                    filter.classList.add('active');
                    const genre = filter.getAttribute('data-genre');
                    displayBooks(allBooks, genre);
                });
            });
        }

        function filterByGenre(genre) {
            const filters = document.querySelectorAll('.genre-filter');
            filters.forEach(f => f.classList.remove('active'));
            filters.forEach(f => {
                if (f.getAttribute('data-genre') === genre) {
                    f.classList.add('active');
                }
            });
            displayBooks(allBooks, genre);
        }

        // EPUB Reader Functions
        function openEpubReader(epubUrl, bookTitle) {
            console.log('Opening EPUB:', epubUrl, 'Title:', bookTitle);
            
            const modal = document.getElementById('readerModal');
            const titleElement = document.getElementById('currentBookTitle');
            const viewer = document.getElementById('viewer');
            
            // Show loading state
            viewer.innerHTML = '<div class="loading"><div class="spinner"></div>Loading book...</div>';
            titleElement.textContent = bookTitle;
            modal.style.display = 'block';
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
            
            // Initialize EPUB.js
            currentBook = ePub(epubUrl);
            
            rendition = currentBook.renderTo("viewer", {
                width: "100%",
                height: "100%",
                spread: "auto"
            });
            
            rendition.display()
                .then(() => {
                    console.log('EPUB loaded successfully');
                })
                .catch(error => {
                    console.error('Error loading EPUB:', error);
                    viewer.innerHTML = `
                        <div class="loading">
                            <div>Error loading book: ${error.message}</div>
                            <p>You can still <a href="${epubUrl}" download>download the EPUB file</a> to read with a local reader.</p>
                        </div>
                    `;
                });
            
            // Set up navigation
            setupReaderNavigation();
        }

        function setupReaderNavigation() {
            document.getElementById('prevPage').addEventListener('click', function() {
                rendition.prev();
            });
            
            document.getElementById('nextPage').addEventListener('click', function() {
                rendition.next();
            });
            
            // Keyboard navigation
            document.addEventListener('keydown', handleReaderKeys);
        }

        function handleReaderKeys(e) {
            if (document.getElementById('readerModal').style.display !== 'block') return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    rendition.prev();
                    break;
                case 'ArrowRight':
                    rendition.next();
                    break;
                case 'Escape':
                    closeReader();
                    break;
            }
        }

        function closeReader() {
            const modal = document.getElementById('readerModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Clean up
            if (rendition) {
                rendition.destroy();
                rendition = null;
            }
            if (currentBook) {
                currentBook.destroy();
                currentBook = null;
            }
            
            // Remove keyboard listener
            document.removeEventListener('keydown', handleReaderKeys);
        }

        // Close reader when close button is clicked
        document.getElementById('readerClose').addEventListener('click', closeReader);

        // Close reader when clicking outside the reader container
        document.getElementById('readerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeReader();
            }
        });
    </script>
</body>
</html>