<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gutenberg Library Reader</title>
    <style>
        /* ... (keep all your existing CSS styles) ... */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Gutenberg Library</h1>
            <div class="subtitle">Explore thousands of free classic books</div>
        </header>

        <div class="controls">
            <div class="search-filter">
                <input type="text" id="searchInput" placeholder="Search books by title or author...">
                <select id="genreFilter">
                    <option value="">All Genres</option>
                </select>
            </div>
        </div>

        <div class="stats" id="stats">Loading books...</div>

        <div class="books-grid" id="booksGrid">
            <div class="loading">Loading books from data.txt...</div>
        </div>
    </div>

    <!-- Book Reader -->
    <div class="reader-overlay" id="readerOverlay">
        <div class="reader-container">
            <div class="reader-header">
                <div class="reader-title" id="readerBookTitle">Loading...</div>
                <div class="reader-controls">
                    <button onclick="changeFontSize(-1)">A-</button>
                    <button onclick="changeFontSize(1)">A+</button>
                    <button onclick="closeReader()">‚úï Close</button>
                </div>
            </div>
            <div class="reader-content" id="readerContent">
                <div class="loading">Loading book content...</div>
            </div>
        </div>
    </div>

    <script>
        let books = [];
        let currentFontSize = 18;

        // Load books from data.txt
        async function loadBooks() {
            try {
                const response = await fetch('data.txt');
                const text = await response.text();
                parseBooks(text);
            } catch (error) {
                console.error('Error loading data.txt:', error);
                document.getElementById('booksGrid').innerHTML = 
                    '<div class="error">Error loading books data. Make sure data.txt is in the same folder.</div>';
            }
        }

        function parseBooks(text) {
            const lines = text.split('\n');
            let currentBook = null;
            let inBookSection = false;
            let currentGenre = '';

            for (const line of lines) {
                // Check for genre section
                if (line.includes('üéØ GENRE:')) {
                    currentGenre = line.split('üéØ GENRE:')[1].split('(')[0].trim();
                    continue;
                }

                // Check for book start
                if (line.includes('üìñ BOOK')) {
                    if (currentBook) {
                        books.push(currentBook);
                    }
                    currentBook = {
                        genre: currentGenre,
                        title: line.split('üìñ BOOK')[1].split(':')[1].trim()
                    };
                    inBookSection = true;
                    continue;
                }

                if (!inBookSection || !currentBook) continue;

                // Parse book details
                if (line.includes('üë§ Author:')) {
                    currentBook.author = line.split('üë§ Author:')[1].trim();
                } else if (line.includes('üÜî ID:')) {
                    currentBook.id = line.split('üÜî ID:')[1].trim();
                } else if (line.includes('üìä Downloads:')) {
                    currentBook.downloads = line.split('üìä Downloads:')[1].trim();
                } else if (line.includes('üñºÔ∏è  Cover:')) {
                    currentBook.cover = line.split('üñºÔ∏è  Cover:')[1].trim();
                } else if (line.includes('üìù Text URL:')) {
                    currentBook.textUrl = line.split('üìù Text URL:')[1].trim();
                } else if (line.includes('üìÑ Format:')) {
                    currentBook.format = line.split('üìÑ Format:')[1].trim();
                } else if (line.includes('üè∑Ô∏è  Subjects:')) {
                    currentBook.subjects = line.split('üè∑Ô∏è  Subjects:')[1].trim();
                } else if (line.includes('üìö Bookshelves:')) {
                    currentBook.bookshelves = line.split('üìö Bookshelves:')[1].trim();
                }

                // End of book section
                if (line.includes('--------------------------------------------------')) {
                    inBookSection = false;
                }
            }

            // Add the last book
            if (currentBook) {
                books.push(currentBook);
            }

            displayBooks(books);
            updateStats();
            populateGenres();
        }

        function displayBooks(booksToShow) {
            const grid = document.getElementById('booksGrid');
            
            if (booksToShow.length === 0) {
                grid.innerHTML = '<div class="no-books">No books found matching your search.</div>';
                return;
            }

            grid.innerHTML = booksToShow.map(book => `
                <div class="book-card" onclick="openBook('${book.textUrl}', '${book.title}')">
                    <div class="book-cover ${book.cover ? 'has-image' : ''}" 
                         style="${book.cover ? `background-image: url('${book.cover}')` : ''}">
                        ${!book.cover ? book.title.substring(0, 30) + (book.title.length > 30 ? '...' : '') : ''}
                    </div>
                    <div class="book-title">${book.title}</div>
                    <div class="book-author">${book.author}</div>
                    <div class="book-meta">
                        üìä ${book.downloads} downloads<br>
                        üè∑Ô∏è ${book.genre}
                    </div>
                    <div class="book-genre">${book.genre}</div>
                    ${book.subjects ? book.subjects.split(', ').slice(0, 2).map(subject => 
                        `<div class="book-genre">${subject}</div>`
                    ).join('') : ''}
                    <button class="read-btn" onclick="event.stopPropagation(); openBook('${book.textUrl}', '${book.title}')">
                        üìñ Read Book
                    </button>
                </div>
            `).join('');
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            stats.textContent = `üìö ${books.length} books loaded ‚Ä¢ Use search and filters to find books`;
        }

        function populateGenres() {
            const genreFilter = document.getElementById('genreFilter');
            const genres = [...new Set(books.map(book => book.genre))].sort();
            
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreFilter.appendChild(option);
            });
        }

        // Search and filter functionality
        document.getElementById('searchInput').addEventListener('input', filterBooks);
        document.getElementById('genreFilter').addEventListener('change', filterBooks);

        function filterBooks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const genreFilter = document.getElementById('genreFilter').value;

            const filteredBooks = books.filter(book => {
                const matchesSearch = book.title.toLowerCase().includes(searchTerm) || 
                                    book.author.toLowerCase().includes(searchTerm);
                const matchesGenre = !genreFilter || book.genre === genreFilter;
                return matchesSearch && matchesGenre;
            });

            displayBooks(filteredBooks);
        }

        // Book reader functions
        async function openBook(textUrl, title) {
            const overlay = document.getElementById('readerOverlay');
            const contentDiv = document.getElementById('readerContent');
            const titleDiv = document.getElementById('readerBookTitle');
            
            titleDiv.textContent = title;
            overlay.style.display = 'flex';
            contentDiv.innerHTML = '<div class="loading">Loading book content...</div>';
            
            try {
                // Try direct fetch first (works for same-origin or CORS-enabled servers)
                let response;
                try {
                    response = await fetch(textUrl);
                } catch (directError) {
                    console.log('Direct fetch failed, trying CORS proxy...');
                    // Fallback to CORS proxy
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(textUrl)}`;
                    response = await fetch(proxyUrl);
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                
                // Clean and format the content
                const cleanedContent = cleanBookContent(text, title);
                contentDiv.innerHTML = `
                    <div class="book-content" style="font-size: ${currentFontSize}px;">
                        ${cleanedContent}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading book:', error);
                contentDiv.innerHTML = `
                    <div class="error">
                        Failed to load book content: ${error.message}<br><br>
                        <button onclick="window.open('${textUrl}', '_blank')" style="
                            padding: 10px 20px; 
                            background: #3498db; 
                            color: white; 
                            border: none; 
                            border-radius: 5px; 
                            cursor: pointer;
                        ">
                            Open in New Tab Instead
                        </button>
                    </div>
                `;
            }
        }

        function cleanBookContent(text, title) {
            console.log('Raw text length:', text.length);
            
            // Multiple strategies to find the actual book content
            let content = text;
            
            // Strategy 1: Look for "START OF THE PROJECT GUTENBERG"
            const startMarkers = [
                '*** START OF THE PROJECT GUTENBERG EBOOK',
                '***START OF THE PROJECT GUTENBERG EBOOK',
                '*** START OF THIS PROJECT GUTENBERG EBOOK',
                'Produced by',
                'Transcriber'
            ];
            
            let startIndex = -1;
            for (const marker of startMarkers) {
                startIndex = text.indexOf(marker);
                if (startIndex !== -1) {
                    console.log('Found start marker:', marker);
                    break;
                }
            }
            
            if (startIndex !== -1) {
                // Find the next line break after the start marker
                const afterStart = text.substring(startIndex);
                const firstLineBreak = afterStart.indexOf('\n');
                if (firstLineBreak !== -1) {
                    content = afterStart.substring(firstLineBreak + 1);
                } else {
                    content = afterStart;
                }
            }
            
            // Strategy 2: Remove common Gutenberg headers
            const headerPatterns = [
                /The Project Gutenberg eBook of .+?\n\n/gs,
                /This ebook is for the use of anyone anywhere.+?www\.gutenberg\.org\./gs,
                /Title: .+?\nAuthor: .+?\nRelease date: .+?\n/gs,
                /Language: .+?\nCredits: .+?\n/gs,
            ];
            
            headerPatterns.forEach(pattern => {
                content = content.replace(pattern, '');
            });
            
            // Strategy 3: Look for the actual story content
            // Often starts with chapter headings or the actual narrative
            const storyStartMarkers = [
                'CHAPTER',
                'Chapter',
                'I\n', // Common start for many books
                'THE\n', // All caps start
                'It was',
                'In the',
                'Once upon'
            ];
            
            for (const marker of storyStartMarkers) {
                const markerIndex = content.indexOf(marker);
                if (markerIndex !== -1 && markerIndex < 1000) { // Only if found near beginning
                    content = content.substring(markerIndex);
                    break;
                }
            }
            
            // Remove end markers
            const endMarkers = [
                '*** END OF THE PROJECT GUTENBERG EBOOK',
                '*** END OF THIS PROJECT GUTENBERG EBOOK',
                'End of the Project Gutenberg',
                'End of Project Gutenberg'
            ];
            
            for (const marker of endMarkers) {
                const endIndex = content.indexOf(marker);
                if (endIndex !== -1) {
                    content = content.substring(0, endIndex);
                    break;
                }
            }
            
            // Format the content into HTML
            const lines = content.split('\n');
            let htmlContent = [];
            let inParagraph = false;
            let currentParagraph = [];
            
            // Add book title
            htmlContent.push(`<h1>${title}</h1>`);
            htmlContent.push('<div style="text-align: center; margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">');
            htmlContent.push('<em>From Project Gutenberg ‚Ä¢ Free eBook</em>');
            htmlContent.push('</div>');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (!line) {
                    // Empty line - end current paragraph
                    if (currentParagraph.length > 0) {
                        htmlContent.push(`<p>${currentParagraph.join(' ')}</p>`);
                        currentParagraph = [];
                    }
                    inParagraph = false;
                    continue;
                }
                
                // Check if this looks like a chapter heading
                if ((line === line.toUpperCase() && line.length < 100 && !line.includes('.') && !line.includes(',')) ||
                    line.startsWith('CHAPTER') || 
                    line.startsWith('Chapter') ||
                    (line.length > 10 && line.length < 200 && /^[IVXLCDM]+$/.test(line.replace(/[^IVXLCDM]/g, '')))) {
                    
                    // End previous paragraph
                    if (currentParagraph.length > 0) {
                        htmlContent.push(`<p>${currentParagraph.join(' ')}</p>`);
                        currentParagraph = [];
                    }
                    
                    // Add chapter heading
                    htmlContent.push(`<h2 class="chapter">${line}</h2>`);
                    inParagraph = false;
                } else {
                    // Regular text line
                    currentParagraph.push(line);
                    inParagraph = true;
                }
            }
            
            // Add the last paragraph if exists
            if (currentParagraph.length > 0) {
                htmlContent.push(`<p>${currentParagraph.join(' ')}</p>`);
            }
            
            // If we didn't find much content, show a message
            if (htmlContent.length <= 3) {
                return `
                    <div class="error">
                        <p>Could not extract readable content from this book.</p>
                        <p>The book file might be in a different format.</p>
                        <button onclick="window.open('${window.currentBookUrl}', '_blank')" style="
                            padding: 10px 20px; 
                            background: #3498db; 
                            color: white; 
                            border: none; 
                            border-radius: 5px; 
                            cursor: pointer;
                        ">
                            View Original File
                        </button>
                    </div>
                `;
            }
            
            return htmlContent.join('\n');
        }

        function closeReader() {
            document.getElementById('readerOverlay').style.display = 'none';
        }

        function changeFontSize(delta) {
            currentFontSize += delta;
            currentFontSize = Math.max(14, Math.min(24, currentFontSize));
            
            const bookContent = document.querySelector('.book-content');
            if (bookContent) {
                bookContent.style.fontSize = currentFontSize + 'px';
            }
        }

        // Close reader when clicking outside
        document.getElementById('readerOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeReader();
            }
        });

        // Store current book URL for fallback
        window.currentBookUrl = '';

        // Load books when page loads
        window.addEventListener('load', loadBooks);
    </script>
</body>
</html>