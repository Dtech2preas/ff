<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORBIT: Game Lobby</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* CSS Reset & Base */
        * { box-sizing: border-box; touch-action: none; }
        body {
            margin: 0; overflow: hidden; background: #000; color: #fff;
            font-family: 'Orbitron', sans-serif;
            display: flex; justify-content: center; align-items: center; height: 100vh;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%);
        }

        .container {
            width: 90%; max-width: 400px; text-align: center;
            padding: 2rem; border: 2px solid #00ffff; border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
            background: rgba(10, 10, 20, 0.9);
            transition: opacity 0.5s ease;
        }

        h1 { margin: 0 0 20px; font-size: 2.5rem; text-shadow: 0 0 10px #0ff; color: #fff; letter-spacing: 2px; }
        p { color: #aaa; margin-bottom: 30px; font-size: 0.9rem; }

        .input-group { margin-bottom: 20px; text-align: left; }
        label { display: block; font-size: 0.8rem; color: #0ff; margin-bottom: 5px; }
        input {
            width: 100%; padding: 12px; background: #111; border: 1px solid #333;
            color: #fff; font-family: 'Orbitron', sans-serif; font-size: 1.1rem;
            text-align: center; border-radius: 5px; outline: none; transition: border 0.3s;
        }
        input:focus { border-color: #f0f; box-shadow: 0 0 10px rgba(255, 0, 255, 0.5); }

        button {
            width: 100%; padding: 15px; background: linear-gradient(45deg, #00ffff, #0088ff);
            border: none; color: #000; font-family: 'Orbitron', sans-serif; font-weight: bold;
            font-size: 1.1rem; cursor: pointer; border-radius: 5px; text-transform: uppercase;
            margin-top: 10px; transition: transform 0.2s, box-shadow 0.2s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #333; color: #555; cursor: not-allowed; }

        button.game-btn {
            background: linear-gradient(45deg, #ff0055, #ff00aa); color: #fff; margin-top: 15px;
            border: 1px solid #ff0055;
        }

        .hidden { display: none; }

        #status-message {
            margin-top: 15px; font-size: 0.8rem; color: #0f0; min-height: 20px;
        }

        .loader {
            border: 3px solid #333; border-top: 3px solid #0ff; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;
            vertical-align: middle; margin-right: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="main-menu" class="container">
        <h1>ORBIT</h1>
        <p>Co-op Challenge Lobby</p>

        <button id="btn-create">Create Room</button>

        <div style="margin: 20px 0; border-top: 1px solid #333; position: relative;">
            <span style="background: #0a0a14; padding: 0 10px; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); color: #555; font-size: 0.8rem;">OR</span>
        </div>

        <div class="input-group">
            <input type="text" id="room-input" placeholder="Enter Room Code" maxlength="10">
        </div>
        <button id="btn-join">Join Room</button>
    </div>

    <div id="lobby-screen" class="container hidden">
        <h1>LOBBY</h1>
        <p>Room Code:</p>
        <h2 id="room-display" style="font-size: 2.5rem; color: #0ff; margin: 10px 0; letter-spacing: 5px; cursor: pointer;" title="Click to Copy">---</h2>

        <div id="connection-status" style="margin: 20px 0; color: #aaa;">
            <div class="loader"></div> Waiting for Player 2...
        </div>

        <div id="host-controls" class="hidden">
            <p style="color: #fff; margin-bottom: 10px;">Select Game Mode:</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="game-btn" onclick="startGame('tunnel')">TUNNEL RUN<br><span style="font-size: 0.7rem; opacity: 0.8;">(Co-op)</span></button>
                <button class="game-btn" onclick="startGame('grid')">GRID DODGE<br><span style="font-size: 0.7rem; opacity: 0.8;">(Co-op)</span></button>
                <button class="game-btn" onclick="startGame('defense')">CORE DEFENSE<br><span style="font-size: 0.7rem; opacity: 0.8;">(Co-op)</span></button>
                <button class="game-btn" onclick="startGame('shooter')">SPACE DUEL<br><span style="font-size: 0.7rem; opacity: 0.8;">(PvP)</span></button>
                <button class="game-btn" onclick="startGame('tictactoe')" style="grid-column: span 2;">TIC-TAC-TOE<br><span style="font-size: 0.7rem; opacity: 0.8;">(PvP Strategy)</span></button>
            </div>
        </div>

        <p id="client-msg" class="hidden">Waiting for Host to start game...</p>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        // DOM Elements
        const screens = {
            main: document.getElementById('main-menu'),
            lobby: document.getElementById('lobby-screen')
        };
        const roomDisplay = document.getElementById('room-display');
        const statusDiv = document.getElementById('connection-status');
        const hostControls = document.getElementById('host-controls');
        const clientMsg = document.getElementById('client-msg');

        // State
        let peer;
        let conn;
        let myRole = null; // 'host' or 'client'
        let roomId = null;

        // --- Functions ---

        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if (screens[name]) screens[name].classList.remove('hidden');
        }

        function initPeer(id = null) {
            peer = new Peer(id);

            peer.on('open', (myId) => {
                console.log('My Peer ID:', myId);
                roomId = myId;
                if (myRole === 'host') {
                    roomDisplay.innerText = myId;
                    showScreen('lobby');
                }
            });

            peer.on('connection', (connection) => {
                console.log('Incoming connection...');
                handleConnection(connection);
            });

            peer.on('error', (err) => {
                console.error(err);
                alert("Connection Error: " + err.type);
                showScreen('main');
            });
        }

        function handleConnection(connection) {
            conn = connection;

            conn.on('open', () => {
                console.log("Connected to partner!");
                statusDiv.innerHTML = `<span style="color:#0f0">●</span> PLAYER 2 CONNECTED`;

                if (myRole === 'host') {
                    hostControls.classList.remove('hidden');
                } else {
                    clientMsg.classList.remove('hidden');
                    roomDisplay.innerText = roomId; // Client might need to know? Not really, but good for confirmation
                    showScreen('lobby');
                }
            });

            conn.on('data', (data) => {
                console.log("Received:", data);
                if (data.type === 'START') {
                    // Redirect Client
                    window.location.href = `${data.game}.html?room=${roomId}&role=client`;
                }
            });

            conn.on('close', () => {
                alert("Partner Disconnected!");
                location.reload();
            });
        }

        // --- Event Listeners ---

        document.getElementById('btn-create').addEventListener('click', () => {
            myRole = 'host';
            // Generate random 5-char ID
            const id = Math.random().toString(36).substring(2, 7).toUpperCase();
            initPeer(id);
        });

        document.getElementById('btn-join').addEventListener('click', () => {
            const inputId = document.getElementById('room-input').value.trim().toUpperCase();
            if (!inputId) return alert("Please enter a Room Code");

            myRole = 'client';
            roomId = inputId; // Store intended room ID
            document.getElementById('btn-join').innerText = "Connecting...";

            // Init as client (no ID needed)
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(inputId);
                conn.on('open', () => {
                    console.log("Connected to Host");
                    statusDiv.innerHTML = `<span style="color:#0f0">●</span> CONNECTED TO HOST`;
                    clientMsg.classList.remove('hidden');
                    roomDisplay.innerText = inputId;
                    showScreen('lobby');
                });
                conn.on('data', (data) => {
                    if (data.type === 'START') {
                        window.location.href = `${data.game}.html?room=${roomId}&role=client`;
                    }
                });
                conn.on('close', () => {
                    alert("Host Disconnected");
                    location.reload();
                });
                // Handle connection errors (e.g. ID not found)
                peer.on('error', (err) => {
                    alert("Could not connect: " + err.type);
                    location.reload();
                });
            });
        });

        // Host Start Function
        window.startGame = (gameType) => {
            if (conn && conn.open) {
                conn.send({ type: 'START', game: gameType });
                // Redirect Host
                // Give a small delay to ensure message sends? usually PeerJS is fast enough but 100ms is safe
                setTimeout(() => {
                    window.location.href = `${gameType}.html?room=${roomId}&role=host`;
                }, 100);
            } else {
                alert("Partner not connected!");
            }
        };

        // Copy Room Code
        roomDisplay.addEventListener('click', () => {
            navigator.clipboard.writeText(roomId).then(() => {
                const original = roomDisplay.style.color;
                roomDisplay.style.color = "#fff";
                setTimeout(() => roomDisplay.style.color = original, 200);
            });
        });

    </script>
</body>
</html>
